name: Test and Publish to Xray

on:
  push:
    branches: [ feature/twilio ]
  pull_request:
    branches: [ feature/twilio ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      NODE_ENV: test
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_DATABASE: ${{ secrets.DB_DATABASE }}
      DB_PUBLIC_HOST: ${{ secrets.DB_PUBLIC_HOST }}
      DB_PUBLIC_USERNAME: ${{ secrets.DB_PUBLIC_USERNAME }}
      DB_PUBLIC_PASSWORD: ${{ secrets.DB_PUBLIC_PASSWORD }}
      DB_PUBLIC_DATABASE: ${{ secrets.DB_PUBLIC_DATABASE }}
      COGNITO_CLIENT_ID: ${{ secrets.COGNITO_CLIENT_ID }}
      COGNITO_CLIENT_SECRET: ${{ secrets.COGNITO_CLIENT_SECRET }}
      COGNITO_USER_POOL_ID: ${{ secrets.COGNITO_USER_POOL_ID }}
      COGNITO_REGION: ${{ secrets.COGNITO_REGION }}
      TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
      TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests (JUnit)
        run: npm run test:ci
        - name: Upload JUnit to Xray
        if: always()
        env:
          XRAY_CLIENT_ID: ${{ secrets.XRAY_CLIENT_ID }}
          XRAY_CLIENT_SECRET: ${{ secrets.XRAY_CLIENT_SECRET }}
          XRAY_PROJECT_KEY: ${{ secrets.XRAY_PROJECT_KEY }}
          XRAY_CLOUD_BASE: ${{ secrets.XRAY_CLOUD_BASE_URL }}
        run: |
          if [ -z "$XRAY_CLOUD_BASE" ]; then XRAY_CLOUD_BASE="https://xray.cloud.getxray.app"; fi
          if [ ! -f reports/junit.xml ]; then echo "No JUnit report found"; exit 0; fi
          echo "Authenticating to Xray Cloud..."
          TOKEN=$(curl -s -H "Content-Type: application/json" \
            -d "{\"client_id\":\"$XRAY_CLIENT_ID\",\"client_secret\":\"$XRAY_CLIENT_SECRET\"}" \
            "$XRAY_CLOUD_BASE/api/v2/authenticate" | tr -d '"')
          echo "Uploading junit.xml to Xray..."
          curl -s -o /dev/null -w "%{http_code}\n" -H "Authorization: Bearer $TOKEN" \
            -F "file=@reports/junit.xml" \
            "$XRAY_CLOUD_BASE/api/v2/import/execution/junit?projectKey=$XRAY_PROJECT_KEY"